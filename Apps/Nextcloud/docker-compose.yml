collabora:
    image: collabora/code:24.04.9.1.1
    depends_on:
      - nextcloud
    deploy:
      resources:
        limits:
          memory: 1024M
          cpus: '1.0'
    expose:
      - 9980
    environment:
      - TZ=$TZ
      - domain=$domain
      - DONT_GEN_SSL_CERT=true
      - extra_params=--o:ssl.enable=false --o:ssl.termination=true --o:welcome.enable=false --o:user_interface.mode=notebookbar
      - username=admin
      - password=$default_pwd
    volumes:
      - /DATA/AppData/nextcloud/collabora:/tmp
    restart: unless-stopped
    networks:
      - nextcloud-network

coturn:
  image: coturn/coturn:4.6.2
  deploy:
    resources:
      limits:
        memory: 256M
        cpus: '0.5'
  ports:
    - "3478:3478/udp"
    - "3478:3478/tcp"
    - "49152-65535:49152-65535/udp"
  environment:
    - TZ=$TZ
  command: 
    - turnserver
    - --listening-port=3478
    - --fingerprint
    - --lt-cred-mech
    - --user=nextcloud:$default_pwd
    - --realm=nextcloud
    - --log-file=stdout
    - --simple-log
  restart: unless-stopped
  networks:
    - nextcloud-network

name: nextcloud

services:
  nextcloud:
    image: nextcloud:30.0.6
    user: $PUID:$PGID
    depends_on:
      - db
      - redis
    deploy:
      resources:
        limits:
          memory: 1024M
          cpus: '1.0'
    expose:
      - 80
    environment:
      - PUID=$PUID
      - PGID=$PGID
      - TZ=$TZ
      - MYSQL_HOST=db
      - MYSQL_DATABASE=nextcloud
      - MYSQL_USER=nextcloud
      - MYSQL_PASSWORD=$default_pwd
      - NEXTCLOUD_TRUSTED_DOMAINS=localhost,$domain
      - OVERWRITEPROTOCOL=https
      - OVERWRITEHOST=$domain
      - TRUSTED_PROXIES=172.16.0.0/12,10.0.0.0/8,192.168.0.0/16
      - REDIS_HOST=redis
      - REDIS_HOST_PORT=6379
      - PHP_MEMORY_LIMIT=512M
      - PHP_UPLOAD_LIMIT=1024M
      - APACHE_BODY_LIMIT=1073741824
      - NEXTCLOUD_INIT_HTACCESS=true
    volumes:
      - /DATA/AppData/nextcloud/html:/var/www/html
      - /DATA/AppData/nextcloud/apps:/var/www/html/custom_apps
      - /DATA/AppData/nextcloud/config:/var/www/html/config
      - /DATA/AppData/nextcloud/data:/var/www/html/data
      - /DATA/Documents:/var/www/html/data/Documents
      - /DATA/Media:/var/www/html/data/Media
      - /DATA/Gallery:/var/www/html/data/Gallery
    restart: unless-stopped
    networks:
      - nextcloud-network

  db:
    image: mariadb:11.2
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
    environment:
      - TZ=$TZ
      - MYSQL_ROOT_PASSWORD=$default_pwd
      - MYSQL_DATABASE=nextcloud
      - MYSQL_USER=nextcloud
      - MYSQL_PASSWORD=$default_pwd
      - MARIADB_AUTO_UPGRADE=1
    volumes:
      - /DATA/AppData/nextcloud/db:/var/lib/mysql
    restart: unless-stopped
    networks:
      - nextcloud-network

  redis:
    image: redis:7.2-alpine
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: '0.25'
    environment:
      - TZ=$TZ
    volumes:
      - /DATA/AppData/nextcloud/redis:/data
    restart: unless-stopped
    networks:
      - nextcloud-network

networks:
  nextcloud-network:
    driver: bridge

x-casaos:
  main: nextcloud
  webui_port: 80
  category: Utilities
  architectures: [amd64, arm64]
  author: Yundera Team
  developer: Nextcloud GmbH
  description:
    en_us: Nextcloud is a suite of client-server software for creating and using file hosting services. It offers functionality similar to Dropbox, Office 365 or Google Drive when used with integrated office suites.
    ko_kr: Nextcloud는 파일 호스팅 서비스를 생성하고 사용하기 위한 클라이언트-서버 소프트웨어 제품군입니다. 통합 오피스 제품군과 함께 사용하면 Dropbox, Office 365 또는 Google Drive와 유사한 기능을 제공합니다.
    zh_cn: Nextcloud是一套用于创建和使用文件托管服务的客户端-服务器软件。与集成的办公套件一起使用时，它提供类似于Dropbox、Office 365或Google Drive的功能。
    fr_fr: Nextcloud est une suite de logiciels client-serveur pour créer et utiliser des services d'hébergement de fichiers. Elle offre des fonctionnalités similaires à Dropbox, Office 365 ou Google Drive lorsqu'elle est utilisée avec des suites bureautiques intégrées.
    es_es: Nextcloud es un conjunto de software cliente-servidor para crear y usar servicios de alojamiento de archivos. Ofrece funcionalidades similares a Dropbox, Office 365 o Google Drive cuando se usa con suites de oficina integradas.
  title:
    en_us: Nextcloud
  tagline:
    en_us: A safe home for all your data
    ko_kr: 모든 데이터를 위한 안전한 보금자리
    zh_cn: 您所有数据的安全之家
    fr_fr: Une maison sûre pour toutes vos données
    es_es: Un hogar seguro para todos sus datos
  icon: https://cdn.jsdelivr.net/gh/Yundera/AppStore@main/Apps/Nextcloud/icon.png
  screenshot: https://cdn.jsdelivr.net/gh/Yundera/AppStore@main/Apps/Nextcloud/screenshot-1.png
  thumbnail: https://cdn.jsdelivr.net/gh/Yundera/AppStore@main/Apps/Nextcloud/thumbnail.png
  tips:
    before_install:
      en_us: |
        **Installation Steps**
        
        1. Access the web interface after installation
        2. Complete the setup wizard (create admin account)
        3. **IMPORTANT**: After setup completion, you will see infinite loading
        4. **SOLUTION**: Stop and restart the app to access dashboard
        5. Database connection will be auto-configured
        
        **Microsoft Teams Alternative Features:**
        - **Nextcloud Talk**: Video calls, chat, screen sharing
        - **Collabora Office**: Real-time document editing (Word/Excel/PowerPoint)
        - **Calendar & Contacts**: Team scheduling
        - **Deck**: Project management (Kanban boards)
        - **TURN Server**: For reliable video calls behind firewalls
        
        **Post-Setup Configuration:**
        1. Language will be auto-detected based on your location
        2. Enable Talk app in Apps menu
        3. Configure Collabora Office integration
        4. Set up TURN server for video calls
        5. Create team channels and invite users
        
        **Database Info (auto-filled):**
        - Host: `db`
        - Database: `nextcloud`
        - User: `nextcloud`
        - Password: Auto-generated
        
        **Known Behavior:**
        - Setup completion → Infinite loading (normal)
        - Restart app → Dashboard works perfectly
        - This is a one-time setup issue
        
        **Data Storage:**
        - App data: `/DATA/AppData/nextcloud/`
        - User files: `/DATA/Documents/`, `/DATA/Media/`, `/DATA/Gallery/`
      ko_kr: |
        **설치 단계**
        
        1. 설치 후 웹 인터페이스 접속
        2. 설정 마법사 완료 (관리자 계정 생성)
        3. **중요**: 설정 완료 후 무한 로딩 화면이 나타남
        4. **해결법**: 앱을 정지하고 재시작하면 대시보드 접근 가능
        5. 데이터베이스 연결은 자동 구성됨
        
        **Microsoft Teams 대안 기능:**
        - **Nextcloud Talk**: 화상통화, 채팅, 화면 공유
        - **Collabora Office**: 실시간 문서 편집 (워드/엑셀/파워포인트)
        - **캘린더 & 연락처**: 팀 일정 관리
        - **Deck**: 프로젝트 관리 (칸반 보드)
        - **TURN 서버**: 방화벽 뒤에서도 안정적인 화상통화
        
        **설치 후 설정:**
        1. 사용자 위치에 따라 언어가 자동 감지됩니다
        2. 앱 메뉴에서 Talk 앱 활성화
        3. Collabora Office 통합 설정
        4. 화상통화용 TURN 서버 설정
        5. 팀 채널 생성 및 사용자 초대
        
        **데이터베이스 정보 (자동 입력):**
        - 호스트: `db`
        - 데이터베이스: `nextcloud`
        - 사용자: `nextcloud`
        - 비밀번호: 자동 생성
        
        **알려진 동작:**
        - 설정 완료 → 무한 로딩 (정상)
        - 앱 재시작 → 대시보드 정상 작동
        - 이는 일회성 설정 문제임
        
        **데이터 저장소:**
        - 앱 데이터: `/DATA/AppData/nextcloud/`
        - 사용자 파일: `/DATA/Documents/`, `/DATA/Media/`, `/DATA/Gallery/`
  index: /