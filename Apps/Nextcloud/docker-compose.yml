name: nextcloud

services:
  nextcloud:
    image: nextcloud:30.0.6
    user: $PUID:$PGID
    depends_on:
      - db
      - redis
    deploy:
      resources:
        limits:
          memory: 1024M
          cpus: '1.0'
    expose:
      - 80
    environment:
      - PUID=$PUID
      - PGID=$PGID
      - TZ=$TZ
      - MYSQL_HOST=db
      - MYSQL_DATABASE=nextcloud
      - MYSQL_USER=nextcloud
      - MYSQL_PASSWORD=$default_pwd
      - NEXTCLOUD_TRUSTED_DOMAINS=localhost,$domain
      - OVERWRITEPROTOCOL=https
      - OVERWRITEHOST=$domain
      - OVERWRITECLIURL=https://$domain
      - APACHE_DISABLE_REWRITE_IP=1
      - TRUSTED_PROXIES=172.16.0.0/12,10.0.0.0/8,192.168.0.0/16
      - REDIS_HOST=redis
      - REDIS_HOST_PORT=6379
    volumes:
      - /DATA/AppData/nextcloud/html:/var/www/html
      - /DATA/AppData/nextcloud/apps:/var/www/html/custom_apps
      - /DATA/AppData/nextcloud/config:/var/www/html/config
      - /DATA/AppData/nextcloud/data:/var/www/html/data
      - /DATA/Documents:/var/www/html/data/Documents
      - /DATA/Media:/var/www/html/data/Media
      - /DATA/Gallery:/var/www/html/data/Gallery
    restart: unless-stopped
    networks:
      - nextcloud-network

  db:
    image: mariadb:11.2
    user: $PUID:$PGID
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
    healthcheck:
      test: ["CMD", "healthcheck.sh", "--connect", "--innodb_initialized"]
      interval: 60s
      timeout: 10s
      retries: 5
      start_period: 120s
    environment:
      - PUID=$PUID
      - PGID=$PGID
      - TZ=$TZ
      - MYSQL_ROOT_PASSWORD=$default_pwd
      - MYSQL_DATABASE=nextcloud
      - MYSQL_USER=nextcloud
      - MYSQL_PASSWORD=$default_pwd
      - MARIADB_AUTO_UPGRADE=1
    volumes:
      - /DATA/AppData/nextcloud/db:/var/lib/mysql
    restart: unless-stopped
    networks:
      - nextcloud-network

  redis:
    image: redis:7.2-alpine
    user: $PUID:$PGID
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: '0.25'
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    environment:
      - PUID=$PUID
      - PGID=$PGID
      - TZ=$TZ
    volumes:
      - /DATA/AppData/nextcloud/redis:/data
    restart: unless-stopped
    networks:
      - nextcloud-network

networks:
  nextcloud-network:
    driver: bridge

x-casaos:
  main: nextcloud
  webui_port: 80
  category: Utilities
  architectures: [amd64, arm64]
  author: Yundera Team
  developer: Nextcloud GmbH
  description:
    en_us: Nextcloud is a suite of client-server software for creating and using file hosting services. It offers functionality similar to Dropbox, Office 365 or Google Drive when used with integrated office suites.
    ko_kr: Nextcloud는 파일 호스팅 서비스를 생성하고 사용하기 위한 클라이언트-서버 소프트웨어 제품군입니다. 통합 오피스 제품군과 함께 사용하면 Dropbox, Office 365 또는 Google Drive와 유사한 기능을 제공합니다.
    zh_cn: Nextcloud是一套用于创建和使用文件托管服务的客户端-服务器软件。与集成的办公套件一起使用时，它提供类似于Dropbox、Office 365或Google Drive的功能。
    fr_fr: Nextcloud est une suite de logiciels client-serveur pour créer et utiliser des services d'hébergement de fichiers. Elle offre des fonctionnalités similaires à Dropbox, Office 365 ou Google Drive lorsqu'elle est utilisée avec des suites bureautiques intégrées.
    es_es: Nextcloud es un conjunto de software cliente-servidor para crear y usar servicios de alojamiento de archivos. Ofrece funcionalidades similares a Dropbox, Office 365 o Google Drive cuando se usa con suites de oficina integradas.
  title:
    en_us: Nextcloud
  tagline:
    en_us: A safe home for all your data
    ko_kr: 모든 데이터를 위한 안전한 보금자리
    zh_cn: 您所有数据的安全之家
    fr_fr: Une maison sûre pour toutes vos données
    es_es: Un hogar seguro para todos sus datos
  icon: https://cdn.jsdelivr.net/gh/Yundera/AppStore@main/Apps/Nextcloud/icon.png
  screenshot: https://cdn.jsdelivr.net/gh/Yundera/AppStore@main/Apps/Nextcloud/screenshot-1.png
  thumbnail: https://cdn.jsdelivr.net/gh/Yundera/AppStore@main/Apps/Nextcloud/thumbnail.png
  tips:
    before_install:
      en_us: |
        **Installation Steps**
        
        1. Wait for all containers to start (DB, Redis, Nextcloud)
        2. Access the web interface after installation
        3. Complete the setup wizard manually
        4. **Important**: Restart the app after first setup if issues occur
        
        **Database Info (auto-filled):**
        - Host: `db`
        - Database: `nextcloud` 
        - User: `nextcloud`
        - Password: Auto-generated
        
        **Troubleshooting:**
        - If app won't activate: Check container logs
        - If Bad Gateway: Wait 2-3 minutes or restart app
        - If login slow: Use "Log in to your device" option
        
        **Data Storage:**
        - App data: `/DATA/AppData/nextcloud/`
        - User files: `/DATA/Documents/`, `/DATA/Media/`, `/DATA/Gallery/`
      ko_kr: |
        **설치 단계**
        
        1. 모든 컨테이너 시작 대기 (DB, Redis, Nextcloud)
        2. 설치 후 웹 인터페이스 접속
        3. 설정 마법사를 수동으로 완료
        4. **중요**: 첫 설정 후 문제 발생 시 앱 재시작
        
        **데이터베이스 정보 (자동 입력):**
        - 호스트: `db`
        - 데이터베이스: `nextcloud`
        - 사용자: `nextcloud`
        - 비밀번호: 자동 생성
        
        **문제 해결:**
        - 앱이 활성화되지 않으면: 컨테이너 로그 확인
        - Bad Gateway 발생 시: 2-3분 대기 또는 앱 재시작
        - 로그인 느림: "기기로 로그인" 옵션 사용
        
        **데이터 저장소:**
        - 앱 데이터: `/DATA/AppData/nextcloud/`
        - 사용자 파일: `/DATA/Documents/`, `/DATA/Media/`, `/DATA/Gallery/`
  index: /