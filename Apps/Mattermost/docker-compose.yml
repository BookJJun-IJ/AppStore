name: mattermost

services:
  postgres:
    image: postgres:13-alpine
    user: $PUID:$PGID
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
    volumes:
      - /DATA/AppData/$AppID/postgres:/var/lib/postgresql/data
    environment:
      POSTGRES_USER: mmuser
      POSTGRES_PASSWORD: $default_pwd
      POSTGRES_DB: mattermost
      PUID: $PUID
      PGID: $PGID
      TZ: $TZ
    networks:
      - mattermost-net

  mattermost:
    image: mattermost/mattermost-team-edition:9.11.0
    user: $PUID:$PGID
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_started
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: '1.0'
    expose:
      - 8065
    volumes:
      - /DATA/AppData/$AppID/config:/mattermost/config
      - /DATA/AppData/$AppID/data:/mattermost/data
      - /DATA/AppData/$AppID/logs:/mattermost/logs
      - /DATA/AppData/$AppID/plugins:/mattermost/plugins
      - /DATA/AppData/$AppID/bleve-indexes:/mattermost/bleve-indexes
    environment:
      PUID: $PUID
      PGID: $PGID
      TZ: $TZ
      
      MM_SQLSETTINGS_DRIVERNAME: postgres
      MM_SQLSETTINGS_DATASOURCE: postgres://mmuser:$default_pwd@postgres:5432/mattermost?sslmode=disable&connect_timeout=10
      MM_SERVICESETTINGS_SITEURL: https://$domain
      MM_SERVICESETTINGS_LISTENADDRESS: ":8065"
      MM_SERVICESETTINGS_ENABLELOCALMODE: false
      
      # 보안 설정
      MM_SERVICESETTINGS_ENABLEDEVELOPER: false
      MM_SERVICESETTINGS_ENABLETESTING: false
      MM_SERVICESETTINGS_ENABLESECURITYFIXALERT: true
      MM_SERVICESETTINGS_ENABLEINSECUREOUTGOINGCONNECTIONS: false
      MM_SERVICESETTINGS_ALLOWCORSFROM: ""
      MM_SERVICESETTINGS_CORSEXPOSEDHEADERS: ""
      MM_SERVICESETTINGS_CORSALLOWCREDENTIALS: false
      
      # 플러그인 설정
      MM_PLUGINSETTINGS_ENABLE: true
      MM_PLUGINSETTINGS_ENABLEUPLOADS: true
      MM_PLUGINSETTINGS_AUTOMATICPREPACKAGEDPLUGINS: true
      MM_PLUGINSETTINGS_ENABLEHEALTHCHECK: true
      
      # 팀 및 사용자 관리
      MM_TEAMSETTINGS_ENABLETEAMCREATION: true
      MM_TEAMSETTINGS_ENABLEUSERCREATION: true
      MM_TEAMSETTINGS_RESTRICTCREATIONTODOMAINS: ""
      MM_TEAMSETTINGS_MAXUSERSPERTEAM: 1000
      MM_TEAMSETTINGS_RESTRICTDIRECTMESSAGE: "any"
      
      # 파일 업로드 설정
      MM_FILESETTINGS_MAXFILESIZE: 52428800
      MM_FILESETTINGS_ENABLEFILEATTACHMENTS: true
      MM_FILESETTINGS_ENABLEMOBILEUPLOAD: true
      MM_FILESETTINGS_ENABLEMOBILEDOWNLOAD: true
      
      # 이메일 설정 (초기에는 비활성화)
      MM_EMAILSETTINGS_SENDEMAILNOTIFICATIONS: false
      MM_EMAILSETTINGS_FEEDBACKEMAIL: ""
      MM_EMAILSETTINGS_REPLYTOADDRESS: ""
      
      # Rate Limiting (보안)
      MM_RATELIMITSETTINGS_ENABLE: true
      MM_RATELIMITSETTINGS_PERSEC: 10
      MM_RATELIMITSETTINGS_MAXBURST: 100
      MM_RATELIMITSETTINGS_MEMORYSTORE: 10000
      MM_RATELIMITSETTINGS_VARYBYREMOTEADDR: true
      MM_RATELIMITSETTINGS_VARYBYHEADER: ""
      
      # 패스워드 정책
      MM_PASSWORDSETTINGS_MINIMUMLENGTH: 8
      MM_PASSWORDSETTINGS_LOWERCASE: true
      MM_PASSWORDSETTINGS_NUMBER: true
      MM_PASSWORDSETTINGS_UPPERCASE: true
      MM_PASSWORDSETTINGS_SYMBOL: false
      
      # 세션 보안
      MM_SERVICESETTINGS_SESSIONLENGTHMOBILEINMINUTES: 43200
      MM_SERVICESETTINGS_SESSIONLENGTHWEBINMINUTES: 43200
      MM_SERVICESETTINGS_SESSIONLENGTHSSOINMINUTES: 43200
      MM_SERVICESETTINGS_SESSIONCACHEINDMINUTES: 10
      MM_SERVICESETTINGS_SESSIONIDLELENGTHGIVEN: 43200
      
      # 로그 설정
      MM_LOGSETTINGS_ENABLECONSOLE: true
      MM_LOGSETTINGS_CONSOLELEVEL: INFO
      MM_LOGSETTINGS_ENABLEFILE: true
      MM_LOGSETTINGS_FILELEVEL: INFO
      MM_LOGSETTINGS_FILEFORMAT: ""
      MM_LOGSETTINGS_FILELOCATION: ""
      
      # 검색 및 인덱싱
      MM_BLEVESETTINGS_INDEXDIR: /mattermost/bleve-indexes
      MM_BLEVESETTINGS_ENABLEINDEXING: true
      MM_BLEVESETTINGS_ENABLESEARCHING: true
      MM_BLEVESETTINGS_ENABLEAUTOCOMPLETE: true
    networks:
      - mattermost-net

networks:
  mattermost-net:
    driver: bridge

x-casaos:
  architectures: [amd64, arm64]
  main: mattermost
  webui_port: 8065
  author: Yundera Team
  category: Communication
  description:
    en_us: Open-source team communication platform similar to Slack
    ko_kr: Slack과 유사한 오픈소스 팀 커뮤니케이션 플랫폼
  developer: Mattermost, Inc.
  icon: https://cdn.jsdelivr.net/gh/Yundera/AppStore@main/Apps/Mattermost/icon.png
  tagline:
    en_us: Team chat and collaboration
    ko_kr: 팀 채팅 및 협업
  title:
    en_us: Mattermost
    ko_kr: Mattermost
  tips:
    before_install:
      en_us: |
        **Simple Mattermost Setup**
        
        1. Visit the web interface after installation
        2. Create your first account (becomes admin)
        3. Create a team and start chatting!
        
        Database password: `$default_pwd`
      ko_kr: |
        **간단한 Mattermost 설정**
        
        1. 설치 후 웹 인터페이스 방문
        2. 첫 번째 계정 생성 (관리자가 됨)
        3. 팀 생성하고 채팅 시작!
        
        데이터베이스 비밀번호: `$default_pwd`
  index: /
  port_map: "8065"
  store_app_id: mattermost
  pre_install_cmd: |
    mkdir -p /DATA/AppData/$AppID/{config,data,logs,plugins,postgres,bleve-indexes} &&
    chown -R $PUID:$PGID /DATA/AppData/$AppID/config /DATA/AppData/$AppID/data /DATA/AppData/$AppID/logs /DATA/AppData/$AppID/plugins /DATA/AppData/$AppID/bleve-indexes &&
    chown -R $PUID:$PGID /DATA/AppData/$AppID/postgres &&
    echo "Mattermost directories created with proper PUID/PGID ownership"