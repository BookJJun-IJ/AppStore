name: mattermost

services:
  postgres:
    image: postgres:13-alpine
    user: $PUID:$PGID  # 🔥 핵심 수정 1
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
    volumes:
      - /DATA/AppData/$AppID/postgres:/var/lib/postgresql/data
    environment:
      PUID: $PUID
      PGID: $PGID
      POSTGRES_USER: mmuser
      POSTGRES_PASSWORD: $default_pwd
      POSTGRES_DB: mattermost
      POSTGRES_INITDB_ARGS: "--encoding=UTF-8"
      PGDATA: /var/lib/postgresql/data/pgdata
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U mmuser -d mattermost"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 120s

  mattermost:
    image: mattermost/mattermost-team-edition:10.9.1
    user: $PUID:$PGID  # 🔥 핵심 수정 2
    restart: unless-stopped
    depends_on:
      - postgres  # 🔥 수정 3: condition 제거 (CasaOS 호환성)
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: '1.0'
    expose:
      - 80
    volumes:
      - /DATA/AppData/$AppID/config:/mattermost/config
      - /DATA/AppData/$AppID/data:/mattermost/data
      - /DATA/AppData/$AppID/logs:/mattermost/logs
      - /DATA/AppData/$AppID/plugins:/mattermost/plugins
    environment:
      PUID: $PUID
      PGID: $PGID
      TZ: $TZ
      
      MM_SQLSETTINGS_DRIVERNAME: postgres
      MM_SQLSETTINGS_DATASOURCE: postgres://mmuser:$default_pwd@postgres:5432/mattermost?sslmode=disable&connect_timeout=10
      MM_SERVICESETTINGS_SITEURL: "https://$domain"
      MM_SERVICESETTINGS_LISTENADDRESS: ":80"
      MM_SERVICESETTINGS_ENABLELOCALMODE: true
      
      # 플러그인 시스템 완전 비활성화 (안정성 우선)
      MM_PLUGINSETTINGS_ENABLE: false
      MM_PLUGINSETTINGS_ENABLEUPLOADS: false
      MM_PLUGINSETTINGS_AUTOMATICPREPACKAGEDPLUGINS: false
      
      MM_TEAMSETTINGS_ENABLETEAMCREATION: true
      MM_TEAMSETTINGS_ENABLEUSERCREATION: true
      
      MM_FILESETTINGS_MAXFILESIZE: 52428800
      
      # 이메일 알림 비활성화
      MM_EMAILSETTINGS_SENDEMAILNOTIFICATIONS: false
      
      # WebSocket 문제 해결 설정
      MM_SERVICESETTINGS_ENABLEINSECUREOUTGOINGCONNECTIONS: true
      MM_SERVICESETTINGS_ALLOWCORSFROM: "*"
      MM_SERVICESETTINGS_WEBSOCKETURL: ""  # 자동 감지로 WebSocket 문제 우회
      MM_SERVICESETTINGS_ALLOWUNTRUSTEDINTERNALCONNECTIONS: true
      
      # 연결 타임아웃 설정
      MM_SERVICESETTINGS_READTIMEOUT: 300
      MM_SERVICESETTINGS_WRITETIMEOUT: 300
      
      # 디버그 로깅 (문제 해결용)
      MM_LOGSETTINGS_FILELEVEL: DEBUG
      MM_LOGSETTINGS_CONSOLELEVEL: DEBUG

# 🔥 수정 4: 커스텀 네트워크 제거 (CasaOS 기본 네트워크 사용)

x-casaos:
  architectures: [amd64, arm64]
  main: mattermost
  webui_port: 80
  author: Yundera Team
  category: Communication
  description:
    en_us: Open-source team communication platform similar to Slack with secure messaging and collaboration features
    ko_kr: Slack과 유사한 오픈소스 팀 커뮤니케이션 플랫폼으로 보안 메시징 및 협업 기능 제공
    fr_fr: Plateforme de communication d'équipe open-source similaire à Slack avec messagerie sécurisée et fonctionnalités de collaboration
    es_es: Plataforma de comunicación de equipo de código abierto similar a Slack con mensajería segura y funciones de colaboración
    zh_cn: 类似Slack的开源团队沟通平台，提供安全消息传递和协作功能
  developer: Mattermost, Inc.
  icon: https://cdn.jsdelivr.net/gh/Yundera/AppStore@main/Apps/Mattermost/icon.png
  tagline:
    en_us: Secure team chat and collaboration
    ko_kr: 보안 팀 채팅 및 협업
    fr_fr: Chat d'équipe et collaboration sécurisés
    es_es: Chat de equipo y colaboración seguros
    zh_cn: 安全的团队聊天和协作
  title:
    en_us: Mattermost
    ko_kr: Mattermost
  tips:
    before_install:
      en_us: |
        **Mattermost Team Communication (Latest Version)**
        
        This uses the latest stable version with basic features enabled.
        
        1. Visit the web interface after installation
        2. Create your first account (becomes system admin)
        3. Create a team and start messaging!
        4. Enable advanced features later in System Console
        
        **Core features included:**
        - Real-time team messaging
        - file sharing capabilities
        - Channel-based organization
        - Direct messaging
        
        **Note**: Plugins disabled initially for stability. Enable them manually in System Console after setup.
        
        Database password: `$default_pwd`
      ko_kr: |
        **Mattermost 팀 커뮤니케이션 (최신 버전)**
        
        기본 기능이 활성화된 최신 안정 버전을 사용합니다.
        
        1. 설치 후 웹 인터페이스 방문
        2. 첫 번째 계정 생성 (시스템 관리자가 됨)
        3. 팀 생성하고 메시징 시작!
        4. 나중에 시스템 콘솔에서 고급 기능 활성화
        
        **포함된 핵심 기능:**
        - 실시간 팀 메시징
        - 파일 공유 기능
        - 채널 기반 조직
        - 다이렉트 메시징
        
        **참고**: 안정성을 위해 플러그인이 초기에 비활성화되어 있습니다. 설정 후 시스템 콘솔에서 수동으로 활성화하세요.
        
        데이터베이스 비밀번호: `$default_pwd`
  # 🔥 수정 5: pre-install 명령 추가
  pre-install-cmd: |
    mkdir -p /DATA/AppData/$AppID/{config,data,logs,plugins,postgres} &&
    chown -R $PUID:$PGID /DATA/AppData/$AppID/
  index: /
  port_map: "80"
  store_app_id: mattermost