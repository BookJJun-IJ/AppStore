name: mattermost
services:
  postgres:
    image: postgres:15-alpine
    user: $PUID:$PGID
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
    volumes:
      - /DATA/AppData/$AppID/postgres:/var/lib/postgresql/data
    environment:
      PUID: $PUID
      PGID: $PGID
      TZ: $TZ
      POSTGRES_USER: mmuser
      POSTGRES_PASSWORD: $default_pwd
      POSTGRES_DB: mattermost
      POSTGRES_INITDB_ARGS: "--encoding=UTF-8"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U mmuser -d mattermost"]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - mattermost-internal

  mattermost:
    image: mattermost/mattermost-team-edition:10.9.1
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
    user: $PUID:$PGID
    deploy:
      resources:
        limits:
          memory: 1024M
          cpus: '1.0'
    expose:
      - 80
    volumes:
      - /DATA/AppData/$AppID/config:/mattermost/config
      - /DATA/AppData/$AppID/data:/mattermost/data
      - /DATA/AppData/$AppID/logs:/mattermost/logs
      - /DATA/AppData/$AppID/plugins:/mattermost/plugins
      - /DATA/AppData/$AppID/client-plugins:/mattermost/client/plugins
      - /DATA/AppData/$AppID/bleve-indexes:/mattermost/bleve-indexes
    environment:
      PUID: $PUID
      PGID: $PGID
      TZ: $TZ
      PASSWORD: $default_pwd
      DOMAIN: $domain
      PUBLIC_IP: $public_ip
      
      # NSL ë¼ìš°í„° í˜¸í™˜ ì„¤ì •
      MM_SERVICESETTINGS_SITEURL: https://$domain
      MM_SERVICESETTINGS_LISTENADDRESS: ":80"
      MM_SERVICESETTINGS_CONNECTIONSECURITY: ""
      MM_SERVICESETTINGS_TLSCERTFILE: ""
      MM_SERVICESETTINGS_TLSKEYFILE: ""
      MM_SERVICESETTINGS_USELETSENCRYT: false
      MM_SERVICESETTINGS_FORWARD80TO443: false
      
      # ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²°
      MM_SQLSETTINGS_DRIVERNAME: postgres
      MM_SQLSETTINGS_DATASOURCE: postgres://mmuser:$default_pwd@postgres:5432/mattermost?sslmode=disable&connect_timeout=10
      
      # íŒŒì¼ ë° ê²€ìƒ‰ ì„¤ì •
      MM_BLEVESETTINGS_INDEXDIR: /mattermost/bleve-indexes
      MM_FILESETTINGS_MAXFILESIZE: 52428800
      
      # ë³´ì•ˆ ì„¤ì • - ê¸°ë³¸ ì¸ì¦ í™œì„±í™”
      MM_SERVICESETTINGS_ENABLEOPENSERVER: true
      MM_SERVICESETTINGS_ENABLELOCALMODE: false
      MM_SERVICESETTINGS_ENABLEDEVELOPER: false
      MM_SERVICESETTINGS_ENABLETESTING: false
      MM_SERVICESETTINGS_ENABLESECURITYFIXALERT: true
      MM_SERVICESETTINGS_ENABLEINSECUREOUTGOINGCONNECTIONS: false
      
      # í”ŒëŸ¬ê·¸ì¸ ë³´ì•ˆ ì„¤ì •
      MM_PLUGINSETTINGS_ENABLE: true
      MM_PLUGINSETTINGS_ENABLEUPLOADS: false
      MM_PLUGINSETTINGS_AUTOMATICPREPACKAGEDPLUGINS: false
      MM_PLUGINSETTINGS_ENABLEHEALTHCHECK: true
      
      # íŒ€ ë° ì‚¬ìš©ì ê´€ë¦¬
      MM_TEAMSETTINGS_ENABLETEAMCREATION: true
      MM_TEAMSETTINGS_ENABLEUSERCREATION: true
      MM_TEAMSETTINGS_RESTRICTCREATIONTODOMAINS: ""
      MM_TEAMSETTINGS_RESTRICTDIRECTMESSAGE: "any"
      
      # ë¡œê·¸ ì„¤ì •
      MM_LOGSETTINGS_ENABLECONSOLE: true
      MM_LOGSETTINGS_CONSOLELEVEL: INFO
      MM_LOGSETTINGS_ENABLEFILE: true
      MM_LOGSETTINGS_FILELEVEL: INFO
      
      # ë ˆì´íŠ¸ ë¦¬ë°‹ ì„¤ì •
      MM_RATELIMITSETTINGS_ENABLE: true
      MM_RATELIMITSETTINGS_PERSEC: 10
      MM_RATELIMITSETTINGS_MAXBURST: 100
      
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:80/api/v4/system/ping"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 90s
    networks:
      - mattermost-internal

networks:
  mattermost-internal:
    driver: bridge
    internal: false

x-casaos:
  architectures:
    - amd64
    - arm64
  main: mattermost
  webui_port: 80
  category: Chat
  author: CasaOS Team
  developer: Mattermost, Inc.
  description:
    en_us: Mattermost is an open-source, self-hostable online chat service with file sharing, search, and integrations. It is designed as an internal chat for organizations and companies, and is marketed as an open-source alternative to Slack and Microsoft Teams. This configuration prioritizes security with minimal plugin exposure and hardened settings.
    fr_fr: Mattermost est un service de chat en ligne open source et auto-hÃ©bergeable avec partage de fichiers, recherche et intÃ©grations. Il est conÃ§u comme un chat interne pour les organisations et les entreprises.
    ko_kr: MattermostëŠ” íŒŒì¼ ê³µìœ , ê²€ìƒ‰ ë° í†µí•© ê¸°ëŠ¥ì„ ê°–ì¶˜ ì˜¤í”ˆ ì†ŒìŠ¤, ìì²´ í˜¸ìŠ¤íŒ… ê°€ëŠ¥í•œ ì˜¨ë¼ì¸ ì±„íŒ… ì„œë¹„ìŠ¤ì…ë‹ˆë‹¤. ì¡°ì§ê³¼ ê¸°ì—…ì„ ìœ„í•œ ë‚´ë¶€ ì±„íŒ…ìœ¼ë¡œ ì„¤ê³„ë˜ì—ˆìŠµë‹ˆë‹¤.
    zh_cn: Mattermostæ˜¯ä¸€ä¸ªå¼€æºçš„ã€å¯è‡ªæ‰˜ç®¡çš„åœ¨çº¿èŠå¤©æœåŠ¡ï¼Œå…·æœ‰æ–‡ä»¶å…±äº«ã€æœç´¢å’Œé›†æˆåŠŸèƒ½ã€‚å®ƒä¸“ä¸ºç»„ç»‡å’Œå…¬å¸çš„å†…éƒ¨èŠå¤©è€Œè®¾è®¡ã€‚
    es_es: Mattermost es un servicio de chat en lÃ­nea de cÃ³digo abierto y auto-hospedable con comparticiÃ³n de archivos, bÃºsqueda e integraciones.
  icon: https://cdn.jsdelivr.net/gh/Yundera/AppStore@main/Apps/Mattermost/icon.png
  screenshot_link:
    - https://cdn.jsdelivr.net/gh/Yundera/AppStore@main/Apps/Mattermost/screenshot-1.png
    - https://cdn.jsdelivr.net/gh/Yundera/AppStore@main/Apps/Mattermost/screenshot-2.png
    - https://cdn.jsdelivr.net/gh/Yundera/AppStore@main/Apps/Mattermost/screenshot-3.png
  tagline:
    en_us: Secure team communication platform with hardened configuration
    fr_fr: Plateforme de communication d'Ã©quipe sÃ©curisÃ©e avec configuration renforcÃ©e
    ko_kr: ê°•í™”ëœ êµ¬ì„±ì˜ ë³´ì•ˆ íŒ€ ì»¤ë®¤ë‹ˆì¼€ì´ì…˜ í”Œë«í¼
    zh_cn: å…·æœ‰å¼ºåŒ–é…ç½®çš„å®‰å…¨å›¢é˜Ÿé€šä¿¡å¹³å°
    es_es: Plataforma de comunicaciÃ³n de equipo segura con configuraciÃ³n reforzada
  thumbnail: https://cdn.jsdelivr.net/gh/Yundera/AppStore@main/Apps/Mattermost/thumbnail.png
  tips:
    before_install:
      en_us: |
        **ğŸ”’ Security-Hardened Mattermost Installation**

        This configuration prioritizes security with the following measures:
        
        **Default Account**
        | Username   | Password       |
        | --------   | ------------   |
        | `admin`    | `$default_pwd` |
        
        **Security Features:**
        - Default authentication enabled
        - Plugin uploads disabled
        - Rate limiting enabled
        - Most plugins disabled by default
        - Development/testing features disabled
        
        **First Setup (Important):**
        1. **Create admin account immediately** - first user becomes system admin
        2. **Disable open server** after setup: System Console > Authentication > Signup
        3. **Review team creation settings**: System Console > Teams
        4. **Configure proper email** if needed: System Console > Email
        
        **NSL Router Integration:**
        - Clean HTTPS URLs via mesh router
        - Automatic SSL termination
        - WebSocket support included
        
        **Default Database:** PostgreSQL with secure password
      ko_kr: |
        **ğŸ”’ ë³´ì•ˆ ê°•í™”ëœ Mattermost ì„¤ì¹˜**

        ì´ êµ¬ì„±ì€ ë‹¤ìŒê³¼ ê°™ì€ ë³´ì•ˆ ì¡°ì¹˜ë¡œ ë³´ì•ˆì„ ìš°ì„ ì‹œí•©ë‹ˆë‹¤:
        
        **ê¸°ë³¸ ê³„ì •**
        | ì‚¬ìš©ìëª…   | ë¹„ë°€ë²ˆí˜¸       |
        | --------   | ------------   |
        | `admin`    | `$default_pwd` |
        
        **ë³´ì•ˆ ê¸°ëŠ¥:**
        - ê¸°ë³¸ ì¸ì¦ í™œì„±í™”
        - í”ŒëŸ¬ê·¸ì¸ ì—…ë¡œë“œ ë¹„í™œì„±í™”
        - ë ˆì´íŠ¸ ë¦¬ë°‹ í™œì„±í™”
        - ëŒ€ë¶€ë¶„ì˜ í”ŒëŸ¬ê·¸ì¸ ê¸°ë³¸ ë¹„í™œì„±í™”
        - ê°œë°œ/í…ŒìŠ¤íŠ¸ ê¸°ëŠ¥ ë¹„í™œì„±í™”
        
        **ì²« ì„¤ì • (ì¤‘ìš”):**
        1. **ì¦‰ì‹œ ê´€ë¦¬ì ê³„ì • ìƒì„±** - ì²« ë²ˆì§¸ ì‚¬ìš©ìê°€ ì‹œìŠ¤í…œ ê´€ë¦¬ìê°€ ë¨
        2. **ì„¤ì • í›„ ê³µê°œ ì„œë²„ ë¹„í™œì„±í™”**: ì‹œìŠ¤í…œ ì½˜ì†” > ì¸ì¦ > ê°€ì…
        3. **íŒ€ ìƒì„± ì„¤ì • ê²€í† **: ì‹œìŠ¤í…œ ì½˜ì†” > íŒ€
        4. **í•„ìš”ì‹œ ì´ë©”ì¼ êµ¬ì„±**: ì‹œìŠ¤í…œ ì½˜ì†” > ì´ë©”ì¼
        
        **NSL ë¼ìš°í„° í†µí•©:**
        - ë©”ì‹œ ë¼ìš°í„°ë¥¼ í†µí•œ ê¹”ë”í•œ HTTPS URL
        - ìë™ SSL ì¢…ë£Œ
        - WebSocket ì§€ì› í¬í•¨
        
        **ê¸°ë³¸ ë°ì´í„°ë² ì´ìŠ¤:** ë³´ì•ˆ ë¹„ë°€ë²ˆí˜¸ê°€ ìˆëŠ” PostgreSQL
  title:
    en_us: Mattermost
    ko_kr: Mattermost
  index: /
  port_map: "80"
  scheme: https
  store_app_id: mattermost
  pre_install_cmd: |
    mkdir -p /DATA/AppData/$AppID/{config,data,logs,plugins,client-plugins,bleve-indexes,postgres} &&
    chown -R $PUID:$PGID /DATA/AppData/$AppID/config /DATA/AppData/$AppID/data /DATA/AppData/$AppID/logs /DATA/AppData/$AppID/plugins /DATA/AppData/$AppID/client-plugins /DATA/AppData/$AppID/bleve-indexes &&
    chown -R 70:70 /DATA/AppData/$AppID/postgres &&
    chmod -R 755 /DATA/AppData/$AppID/config /DATA/AppData/$AppID/data /DATA/AppData/$AppID/logs /DATA/AppData/$AppID/plugins /DATA/AppData/$AppID/client-plugins /DATA/AppData/$AppID/bleve-indexes &&
    chmod -R 700 /DATA/AppData/$AppID/postgres &&
    echo "Mattermost installation setup completed with proper permissions"