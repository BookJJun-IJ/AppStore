name: mattermost

services:
  postgres:
    image: postgres:13-alpine
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
    volumes:
      - /DATA/AppData/$AppID/postgres:/var/lib/postgresql/data
    environment:
      POSTGRES_USER: mmuser
      POSTGRES_PASSWORD: $default_pwd
      POSTGRES_DB: mattermost
      POSTGRES_INITDB_ARGS: "--encoding=UTF-8"
      PGDATA: /var/lib/postgresql/data/pgdata
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U mmuser -d mattermost"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 120s

  mattermost:
    image: mattermost/mattermost-team-edition:10.9.1
    restart: unless-stopped
    depends_on:
      - postgres
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: '1.0'
    expose:
      - 3000  # 🔥 포트 변경: 80 → 3000
    volumes:
      - /DATA/AppData/$AppID/config:/mattermost/config
      - /DATA/AppData/$AppID/data:/mattermost/data
      - /DATA/AppData/$AppID/logs:/mattermost/logs
      - /DATA/AppData/$AppID/plugins:/mattermost/plugins
    environment:
      PUID: $PUID
      PGID: $PGID
      TZ: $TZ
      
      MM_SQLSETTINGS_DRIVERNAME: postgres
      MM_SQLSETTINGS_DATASOURCE: postgres://mmuser:$default_pwd@postgres:5432/mattermost?sslmode=disable&connect_timeout=10
      MM_SERVICESETTINGS_SITEURL: "https://3000-$domain"  # 🔥 URL 변경
      MM_SERVICESETTINGS_LISTENADDRESS: ":3000"  # 🔥 포트 변경
      MM_SERVICESETTINGS_ENABLELOCALMODE: true
      
      # WebSocket 문제 해결 설정
      MM_SERVICESETTINGS_WEBSOCKETURL: ""
      MM_SERVICESETTINGS_ALLOWUNTRUSTEDINTERNALCONNECTIONS: true
      MM_SERVICESETTINGS_ENABLEINSECUREOUTGOINGCONNECTIONS: true
      MM_SERVICESETTINGS_ALLOWCORSFROM: "*"
      
      # Teams 대체용 플러그인 시스템 활성화
      MM_PLUGINSETTINGS_ENABLE: true
      MM_PLUGINSETTINGS_ENABLEUPLOADS: true
      MM_PLUGINSETTINGS_AUTOMATICPREPACKAGEDPLUGINS: true
      
      # 화상회의 및 협업 기능
      MM_PLUGINSETTINGS_ENABLEJITSI: true
      MM_PLUGINSETTINGS_ENABLEZOOM: true
      
      # 파일 공유 및 Office 통합
      MM_SERVICESETTINGS_ENABLEFILEATTACHMENTS: true
      MM_FILESETTINGS_ENABLEFILEATTACHMENTS: true
      MM_FILESETTINGS_ENABLEPUBLICLINK: true
      
      MM_TEAMSETTINGS_ENABLETEAMCREATION: true
      MM_TEAMSETTINGS_ENABLEUSERCREATION: true
      
      # Teams 대체용 파일 및 미디어 설정
      MM_FILESETTINGS_MAXFILESIZE: 104857600  # 100MB (Teams와 유사)
      MM_FILESETTINGS_ENABLEFILEATTACHMENTS: true
      MM_FILESETTINGS_ENABLEPUBLICLINK: true
      
      # 알림 및 멘션 설정 (Teams와 유사)
      MM_NOTIFICATIONSETTINGS_DEFAULTSERVERPUSHENABLED: true
      MM_NOTIFICATIONSETTINGS_DEFAULTCHANNELPUSHENABLED: true
      MM_NOTIFICATIONSETTINGS_DEFAULTDESKTOPNOTIFICATIONSENABLED: true
      
      # 이메일 알림 활성화 (Teams 대체용)
      MM_EMAILSETTINGS_SENDEMAILNOTIFICATIONS: true
      MM_EMAILSETTINGS_ENABLEEMAILBATCHING: true

x-casaos:
  architectures: [amd64, arm64]
  main: mattermost
  webui_port: 3000  # 🔥 CasaOS에도 포트 변경 알림
  author: Yundera Team
  category: Communication
  description:
    en_us: Open-source team communication platform similar to Slack with secure messaging and collaboration features
    ko_kr: Slack과 유사한 오픈소스 팀 커뮤니케이션 플랫폼으로 보안 메시징 및 협업 기능 제공
  developer: Mattermost, Inc.
  icon: https://cdn.jsdelivr.net/gh/Yundera/AppStore@main/Apps/Mattermost/icon.png
  tagline:
    en_us: Secure team