name: mattermost
services:
  postgres:
    image: postgres:15-alpine
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
    volumes:
      - /DATA/AppData/$AppID/postgres:/var/lib/postgresql/data
    environment:
      POSTGRES_USER: mmuser
      POSTGRES_PASSWORD: $default_pwd
      POSTGRES_DB: mattermost
      POSTGRES_INITDB_ARGS: "--encoding=UTF-8"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U mmuser -d mattermost"]
      interval: 30s
      timeout: 10s
      retries: 3

  mattermost:
    image: mattermost/mattermost-team-edition:10.9.1
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
    user: $PUID:$PGID
    deploy:
      resources:
        limits:
          memory: 1024M
          cpus: '1.0'
    expose:
      - 80
    volumes:
      - /DATA/AppData/$AppID/config:/mattermost/config:rw
      - /DATA/AppData/$AppID/data:/mattermost/data:rw
      - /DATA/AppData/$AppID/logs:/mattermost/logs:rw
      - /DATA/AppData/$AppID/plugins:/mattermost/plugins:rw
      - /DATA/AppData/$AppID/client-plugins:/mattermost/client/plugins:rw
      - /DATA/AppData/$AppID/bleve-indexes:/mattermost/bleve-indexes:rw
    environment:
      TZ: $TZ
      MM_SERVICESETTINGS_SITEURL: https://$domain
      MM_SERVICESETTINGS_LISTENADDRESS: ":80"
      MM_SQLSETTINGS_DRIVERNAME: postgres
      MM_SQLSETTINGS_DATASOURCE: postgres://mmuser:$default_pwd@postgres:5432/mattermost?sslmode=disable&connect_timeout=10
      MM_BLEVESETTINGS_INDEXDIR: /mattermost/bleve-indexes
      MM_SERVICESETTINGS_ENABLELOCALMODE: false
      MM_SERVICESETTINGS_ENABLEOPENSERVER: true
      MM_EMAILSETTINGS_SENDEMAILNOTIFICATIONS: false
      # 플러그인 관련 설정 - AI 플러그인 비활성화
      MM_PLUGINSETTINGS_ENABLE: true
      MM_PLUGINSETTINGS_ENABLEUPLOADS: true
      MM_PLUGINSETTINGS_AUTOMATICPREPACKAGEDPLUGINS: false
      # 시스템 콘솔 접근 허용
      MM_SERVICESETTINGS_ENABLEAPIUSERLOOKUPBYLASTNAME: true
      MM_SERVICESETTINGS_ENABLEAPIUSERLOOKUPBYFIRSTNAME: true
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:80/api/v4/system/ping"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 90s

x-casaos:
  architectures:
    - amd64
    - arm64
  main: mattermost
  webui_port: 80
  author: CasaOS Team
  category: Chat
  description:
    en_us: Mattermost is an open-source, self-hostable online chat service with file sharing, search, and integrations. It is designed as an internal chat for organizations and companies, and is marketed as an open-source alternative to Slack and Microsoft Teams. Features secure messaging, file sharing, search capabilities, and extensive integrations for team collaboration.
    ko_kr: Mattermost는 파일 공유, 검색 및 통합 기능을 갖춘 오픈 소스, 자체 호스팅 가능한 온라인 채팅 서비스입니다. 조직과 기업을 위한 내부 채팅으로 설계되었으며 Slack과 Microsoft Teams의 오픈 소스 대안으로 마케팅됩니다. 보안 메시징, 파일 공유, 검색 기능 및 팀 협업을 위한 광범위한 통합을 제공합니다.
  developer: Mattermost, Inc.
  icon: https://cdn.jsdelivr.net/gh/Yundera/AppStore@main/Apps/Mattermost/icon.png
  screenshot_link:
    - https://cdn.jsdelivr.net/gh/Yundera/AppStore@main/Apps/Mattermost/screenshot-1.png
    - https://cdn.jsdelivr.net/gh/Yundera/AppStore@main/Apps/Mattermost/screenshot-2.png
    - https://cdn.jsdelivr.net/gh/Yundera/AppStore@main/Apps/Mattermost/screenshot-3.png
  tagline:
    en_us: Open-source team communication and collaboration platform
    ko_kr: 오픈 소스 팀 커뮤니케이션 및 협업 플랫폼
  thumbnail: https://cdn.jsdelivr.net/gh/Yundera/AppStore@main/Apps/Mattermost/thumbnail.png
  tips:
    before_install:
      en_us: |
        **Getting Started with Mattermost**

        After installation, you can access Mattermost via the web interface. The first user to register will become the system administrator.

        **Default Configuration:**
        - Database: PostgreSQL with secure password
        - Open server registration: Enabled (can be disabled after setup)
        - Email notifications: Disabled by default
        - Automatic plugin installation: Disabled to prevent conflicts

        **First Steps:**
        1. Create your admin account (first user becomes admin)
        2. Set up your team and channels
        3. Configure email settings (optional)
        4. Invite team members
        5. Enable/disable plugins as needed in System Console

        **Note:** Some plugins are disabled by default to prevent license conflicts in Team Edition.

        For more information, visit the [Mattermost Documentation](https://docs.mattermost.com/).
      ko_kr: |
        **Mattermost 시작하기**

        설치 후 웹 인터페이스를 통해 Mattermost에 액세스할 수 있습니다. 가장 먼저 등록하는 사용자가 시스템 관리자가 됩니다.

        **기본 구성:**
        - 데이터베이스: 보안 비밀번호가 있는 PostgreSQL
        - 공개 서버 등록: 활성화됨 (설정 후 비활성화 가능)
        - 이메일 알림: 기본적으로 비활성화됨
        - 자동 플러그인 설치: 충돌 방지를 위해 비활성화됨

        **첫 번째 단계:**
        1. 관리자 계정 생성 (첫 번째 사용자가 관리자가 됨)
        2. 팀 및 채널 설정
        3. 이메일 설정 구성 (선택사항)
        4. 팀 멤버 초대
        5. 시스템 콘솔에서 필요에 따라 플러그인 활성화/비활성화

        **참고:** Team Edition에서 라이선스 충돌을 방지하기 위해 일부 플러그인이 기본적으로 비활성화되어 있습니다.

        더 많은 정보는 [Mattermost 문서](https://docs.mattermost.com/)를 참조하세요.
  title:
    en_us: Mattermost
    ko_kr: Mattermost
  index: /
  port_map: "80"
  scheme: https
  store_app_id: mattermost
  pre_install_cmd: |
    rm -rf /DATA/AppData/$AppID/* &&
    mkdir -p /DATA/AppData/$AppID/{config,data,logs,plugins,client-plugins,bleve-indexes,postgres} &&
    chown -R 70:70 /DATA/AppData/$AppID/postgres &&
    chown -R $PUID:$PGID /DATA/AppData/$AppID/config /DATA/AppData/$AppID/data /DATA/AppData/$AppID/logs /DATA/AppData/$AppID/plugins /DATA/AppData/$AppID/client-plugins /DATA/AppData/$AppID/bleve-indexes &&
    echo "Pre-installation setup completed"