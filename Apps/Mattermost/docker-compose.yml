name: mattermost

services:
  postgres:
    image: postgres:15-alpine
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
    volumes:
      - /DATA/AppData/$AppID/postgres:/var/lib/postgresql/data
    environment:
      POSTGRES_USER: mmuser
      POSTGRES_PASSWORD: $default_pwd
      POSTGRES_DB: mattermost
      POSTGRES_INITDB_ARGS: "--encoding=UTF-8"
      PGDATA: /var/lib/postgresql/data/pgdata
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U mmuser -d mattermost"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    networks:
      - mattermost-internal

  mattermost:
    image: mattermost/mattermost-team-edition:10.9.1
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
    user: $PUID:$PGID
    deploy:
      resources:
        limits:
          memory: 1024M
          cpus: '1.0'
        reservations:
          memory: 512M
    expose:
      - 80
    volumes:
      - /DATA/AppData/$AppID/config:/mattermost/config:rw
      - /DATA/AppData/$AppID/data:/mattermost/data:rw
      - /DATA/AppData/$AppID/logs:/mattermost/logs:rw
      - /DATA/AppData/$AppID/plugins:/mattermost/plugins:rw
      - /DATA/AppData/$AppID/bleve-indexes:/mattermost/bleve-indexes:rw
      - /DATA/AppData/$AppID/client:/mattermost/client:rw
    environment:
      TZ: $TZ
      PUID: $PUID
      PGID: $PGID
      
      # Server Settings
      MM_SERVICESETTINGS_SITEURL: https://$domain
      MM_SERVICESETTINGS_LISTENADDRESS: ":80"
      MM_SERVICESETTINGS_CONNECTIONSECURITY: ""
      MM_SERVICESETTINGS_TLSCERTFILE: ""
      MM_SERVICESETTINGS_TLSKEYFILE: ""
      MM_SERVICESETTINGS_USELETSENCRYT: false
      MM_SERVICESETTINGS_FORWARD80TO443: false
      MM_SERVICESETTINGS_ENABLEOPENSERVER: true
      MM_SERVICESETTINGS_ENABLELOCALMODE: false
      MM_SERVICESETTINGS_ENABLEDEVELOPER: false
      MM_SERVICESETTINGS_ENABLETESTING: false
      MM_SERVICESETTINGS_ENABLESECURITYFIXALERT: true
      MM_SERVICESETTINGS_ENABLEINSECUREOUTGOINGCONNECTIONS: false
      
      # Database Settings
      MM_SQLSETTINGS_DRIVERNAME: postgres
      MM_SQLSETTINGS_DATASOURCE: postgres://mmuser:$default_pwd@postgres:5432/mattermost?sslmode=disable&connect_timeout=10
      
      # File Settings
      MM_FILESETTINGS_MAXFILESIZE: 52428800
      MM_BLEVESETTINGS_INDEXDIR: /mattermost/bleve-indexes
      
      # Email Settings (disabled for initial setup)
      MM_EMAILSETTINGS_SENDEMAILNOTIFICATIONS: false
      MM_EMAILSETTINGS_FEEDBACKEMAIL: ""
      MM_EMAILSETTINGS_REPLYTOADDRESS: ""
      
      # Plugin Settings
      MM_PLUGINSETTINGS_ENABLE: true
      MM_PLUGINSETTINGS_ENABLEUPLOADS: true
      MM_PLUGINSETTINGS_AUTOMATICPREPACKAGEDPLUGINS: true
      MM_PLUGINSETTINGS_ENABLEHEALTHCHECK: true
      
      # Team Settings
      MM_TEAMSETTINGS_ENABLETEAMCREATION: true
      MM_TEAMSETTINGS_ENABLEUSERCREATION: true
      MM_TEAMSETTINGS_RESTRICTCREATIONTODOMAINS: ""
      MM_TEAMSETTINGS_RESTRICTDIRECTMESSAGE: "any"
      
      # Service Settings
      MM_SERVICESETTINGS_ENABLECOMMANDS: true
      MM_SERVICESETTINGS_ENABLEONLYAMININTEGRATIONS: false
      MM_SERVICESETTINGS_ENABLEPOSTUSERNAMEOVERRIDE: false
      MM_SERVICESETTINGS_ENABLEPOSTICONOVERRIDE: false
      MM_SERVICESETTINGS_ENABLECUSTOMEMOJI: true
      
      # Log Settings
      MM_LOGSETTINGS_ENABLECONSOLE: true
      MM_LOGSETTINGS_CONSOLELEVEL: INFO
      MM_LOGSETTINGS_ENABLEFILE: true
      MM_LOGSETTINGS_FILELEVEL: INFO
      
      # Rate Limit Settings
      MM_RATELIMITSETTINGS_ENABLE: true
      MM_RATELIMITSETTINGS_PERSEC: 50
      MM_RATELIMITSETTINGS_MAXBURST: 500
      
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:80/api/v4/system/ping"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 120s
    networks:
      - mattermost-internal

networks:
  mattermost-internal:
    driver: bridge

x-casaos:
  architectures: [amd64, arm64]
  main: mattermost
  webui_port: 80
  author: Yundera Team
  category: Communication
  description:
    en_us: |
      Mattermost is an open-source, self-hostable online chat service with file sharing, search, and integrations. 
      It is designed as an internal chat for organizations and companies, and is marketed as an open-source 
      alternative to Slack and Microsoft Teams.
      
      **Key Features:**
      - Secure team messaging and file sharing
      - Voice calls and screen sharing  
      - Custom integrations and bots
      - Mobile and desktop applications
      - Advanced search and archiving
      - Plugin marketplace
    ko_kr: |
      MattermostÎäî ÌååÏùº Í≥µÏú†, Í≤ÄÏÉâ Î∞è ÌÜµÌï© Í∏∞Îä•ÏùÑ Í∞ñÏ∂ò Ïò§ÌîàÏÜåÏä§ ÏûêÏ≤¥ Ìò∏Ïä§ÌåÖ Ïò®ÎùºÏù∏ Ï±ÑÌåÖ ÏÑúÎπÑÏä§ÏûÖÎãàÎã§.
      Ï°∞ÏßÅÍ≥º Í∏∞ÏóÖÏùÑ ÏúÑÌïú ÎÇ¥Î∂Ä Ï±ÑÌåÖÏúºÎ°ú ÏÑ§Í≥ÑÎêòÏóàÏúºÎ©∞ SlackÍ≥º Microsoft TeamsÏùò Ïò§ÌîàÏÜåÏä§ ÎåÄÏïàÏûÖÎãàÎã§.
      
      **Ï£ºÏöî Í∏∞Îä•:**
      - ÏïàÏ†ÑÌïú ÌåÄ Î©îÏãúÏßï Î∞è ÌååÏùº Í≥µÏú†
      - ÏùåÏÑ± ÌÜµÌôî Î∞è ÌôîÎ©¥ Í≥µÏú†
      - ÏÇ¨Ïö©Ïûê Ï†ïÏùò ÌÜµÌï© Î∞è Î¥á
      - Î™®Î∞îÏùº Î∞è Îç∞Ïä§ÌÅ¨ÌÜ± Ïï†ÌîåÎ¶¨ÏºÄÏù¥ÏÖò
      - Í≥†Í∏â Í≤ÄÏÉâ Î∞è ÏïÑÏπ¥Ïù¥Îπô
      - ÌîåÎü¨Í∑∏Ïù∏ ÎßàÏºìÌîåÎ†àÏù¥Ïä§
  developer: Mattermost, Inc.
  icon: https://cdn.jsdelivr.net/gh/Yundera/AppStore@main/Apps/Mattermost/icon.png
  screenshot_link:
    - https://cdn.jsdelivr.net/gh/Yundera/AppStore@main/Apps/Mattermost/screenshot-1.png
    - https://cdn.jsdelivr.net/gh/Yundera/AppStore@main/Apps/Mattermost/screenshot-2.png
    - https://cdn.jsdelivr.net/gh/Yundera/AppStore@main/Apps/Mattermost/screenshot-3.png
  tagline:
    en_us: Open-source team communication platform
    ko_kr: Ïò§ÌîàÏÜåÏä§ ÌåÄ Ïª§ÎÆ§ÎãàÏºÄÏù¥ÏÖò ÌîåÎû´Ìèº
  thumbnail: https://cdn.jsdelivr.net/gh/Yundera/AppStore@main/Apps/Mattermost/thumbnail.png
  tips:
    before_install:
      en_us: |
        **üöÄ Mattermost Setup Guide**

        **IMPORTANT: First Setup Steps**
        1. **Access the web interface** - Visit your Mattermost URL after installation
        2. **Create admin account** - The first user becomes the system administrator
        3. **Create your team** - Set up your organization's workspace
        
        **Default Settings:**
        - Team and user creation enabled
        - Open server registration (disable after setup if needed)
        - Plugins enabled with marketplace access
        - File uploads enabled (50MB limit)
        
        **Security Notes:**
        - Database password is auto-generated: `$default_pwd`
        - Consider disabling open registration after initial setup
        - Review plugin permissions before enabling
        
        **Troubleshooting:**
        - If loading takes time, wait for database initialization
        - Check logs at `/DATA/AppData/mattermost/logs/` if needed
        - First user registration creates the admin account
      ko_kr: |
        **üöÄ Mattermost ÏÑ§Ï†ï Í∞ÄÏù¥Îìú**

        **Ï§ëÏöî: Ï≤´ ÏÑ§Ï†ï Îã®Í≥Ñ**
        1. **Ïõπ Ïù∏ÌÑ∞ÌéòÏù¥Ïä§ Ï†ëÏÜç** - ÏÑ§Ïπò ÌõÑ Mattermost URL Î∞©Î¨∏
        2. **Í¥ÄÎ¶¨Ïûê Í≥ÑÏ†ï ÏÉùÏÑ±** - Ï≤´ Î≤àÏß∏ ÏÇ¨Ïö©ÏûêÍ∞Ä ÏãúÏä§ÌÖú Í¥ÄÎ¶¨ÏûêÍ∞Ä Îê©ÎãàÎã§
        3. **ÌåÄ ÏÉùÏÑ±** - Ï°∞ÏßÅÏùò ÏõåÌÅ¨Ïä§ÌéòÏù¥Ïä§ ÏÑ§Ï†ï
        
        **Í∏∞Î≥∏ ÏÑ§Ï†ï:**
        - ÌåÄ Î∞è ÏÇ¨Ïö©Ïûê ÏÉùÏÑ± ÌôúÏÑ±Ìôî
        - Í≥µÍ∞ú ÏÑúÎ≤Ñ Îì±Î°ù (ÏÑ§Ï†ï ÌõÑ ÌïÑÏöîÏãú ÎπÑÌôúÏÑ±Ìôî)
        - ÎßàÏºìÌîåÎ†àÏù¥Ïä§ Ï†ëÍ∑ºÏù¥ Í∞ÄÎä•Ìïú ÌîåÎü¨Í∑∏Ïù∏ ÌôúÏÑ±Ìôî
        - ÌååÏùº ÏóÖÎ°úÎìú ÌôúÏÑ±Ìôî (50MB Ï†úÌïú)
        
        **Î≥¥Ïïà Ï∞∏Í≥†ÏÇ¨Ìï≠:**
        - Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§ ÎπÑÎ∞ÄÎ≤àÌò∏ ÏûêÎèô ÏÉùÏÑ±: `$default_pwd`
        - Ï¥àÍ∏∞ ÏÑ§Ï†ï ÌõÑ Í≥µÍ∞ú Îì±Î°ù ÎπÑÌôúÏÑ±Ìôî Í≥†Î†§
        - ÌîåÎü¨Í∑∏Ïù∏ ÌôúÏÑ±Ìôî Ï†Ñ Í∂åÌïú Í≤ÄÌÜ†
        
        **Î¨∏Ï†ú Ìï¥Í≤∞:**
        - Î°úÎî©Ïù¥ Ïò§Îûò Í±∏Î¶¨Î©¥ Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§ Ï¥àÍ∏∞Ìôî ÎåÄÍ∏∞
        - ÌïÑÏöîÏãú `/DATA/AppData/mattermost/logs/`ÏóêÏÑú Î°úÍ∑∏ ÌôïÏù∏
        - Ï≤´ Î≤àÏß∏ ÏÇ¨Ïö©Ïûê Îì±Î°ùÏù¥ Í¥ÄÎ¶¨Ïûê Í≥ÑÏ†ïÏùÑ ÏÉùÏÑ±
  title:
    en_us: Mattermost
    ko_kr: Mattermost
  index: /
  port_map: "80"
  scheme: https
  store_app_id: mattermost
  pre_install_cmd: |
    # Í∏∞Ï°¥ Îç∞Ïù¥ÌÑ∞ Ï†ïÎ¶¨ Î∞è ÎîîÎ†âÌÜ†Î¶¨ ÏÉùÏÑ±
    rm -rf /DATA/AppData/$AppID/* 2>/dev/null || true &&
    mkdir -p /DATA/AppData/$AppID/{config,data,logs,plugins,bleve-indexes,postgres,client} &&
    
    # PostgreSQL Í∂åÌïú ÏÑ§Ï†ï (postgres ÏÇ¨Ïö©Ïûê ID: 70)
    chown -R 70:70 /DATA/AppData/$AppID/postgres &&
    chmod -R 700 /DATA/AppData/$AppID/postgres &&
    
    # Mattermost Í∂åÌïú ÏÑ§Ï†ï
    chown -R $PUID:$PGID /DATA/AppData/$AppID/config /DATA/AppData/$AppID/data /DATA/AppData/$AppID/logs /DATA/AppData/$AppID/plugins /DATA/AppData/$AppID/bleve-indexes /DATA/AppData/$AppID/client &&
    chmod -R 755 /DATA/AppData/$AppID/config /DATA/AppData/$AppID/data /DATA/AppData/$AppID/logs /DATA/AppData/$AppID/plugins /DATA/AppData/$AppID/bleve-indexes /DATA/AppData/$AppID/client &&
    
    # Í∏∞Î≥∏ ÏÑ§Ï†ï ÌååÏùº ÏÉùÏÑ±
    docker run --rm -v /DATA/AppData/$AppID/config:/config mattermost/mattermost-team-edition:10.9.1 sh -c "
      if [ ! -f /config/config.json ]; then
        cp /mattermost/config/config.json /config/config.json || true
      fi
    " &&
    
    chown -R $PUID:$PGID /DATA/AppData/$AppID/config &&
    
    echo "Mattermost installation setup completed successfully"