name: mattermost
services:
  postgres:
    image: postgres:15-alpine
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
    volumes:
      - /DATA/AppData/$AppID/postgres:/var/lib/postgresql/data
    environment:
      POSTGRES_USER: mmuser
      POSTGRES_PASSWORD: $default_pwd
      POSTGRES_DB: mattermost
      POSTGRES_INITDB_ARGS: "--encoding=UTF-8"
      # PostgreSQL ê¶Œí•œ ë¬¸ì œ í•´ê²°
      PGDATA: /var/lib/postgresql/data/pgdata
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U mmuser -d mattermost"]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - mattermost-internal

  mattermost:
    image: mattermost/mattermost-team-edition:10.9.1
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
    user: $PUID:$PGID
    # íŒŒì¼ ê¶Œí•œ ë¬¸ì œ í•´ê²°ì„ ìœ„í•œ ìˆ˜ì •
    read_only: false
    tmpfs:
      - /tmp:noexec,nosuid,size=512m
      - /mattermost/tmp:noexec,nosuid,size=256m  # Mattermost ì „ìš© ì„ì‹œ ë””ë ‰í† ë¦¬
    cap_drop:
      - ALL
    cap_add:
      - CHOWN
      - SETUID
      - SETGID
      - NET_BIND_SERVICE
      - DAC_OVERRIDE  # íŒŒì¼ ê¶Œí•œ ì˜¤ë²„ë¼ì´ë“œ ì¶”ê°€
    security_opt:
      - no-new-privileges:true
    deploy:
      resources:
        limits:
          memory: 1024M
          cpus: '1.0'
        reservations:
          memory: 512M
    expose:
      - 80
    volumes:
      - /DATA/AppData/$AppID/config:/mattermost/config:rw
      - /DATA/AppData/$AppID/data:/mattermost/data:rw
      - /DATA/AppData/$AppID/logs:/mattermost/logs:rw
      - /DATA/AppData/$AppID/plugins:/mattermost/plugins:rw
      - /DATA/AppData/$AppID/client-plugins:/mattermost/client/plugins:rw
      - /DATA/AppData/$AppID/bleve-indexes:/mattermost/bleve-indexes:rw
      # í´ë¼ì´ì–¸íŠ¸ íŒŒì¼ì€ ì»¨í…Œì´ë„ˆ ë‚´ë¶€ íŒŒì¼ì„ ì‚¬ìš©í•˜ë„ë¡ ì œê±°
    environment:
      TZ: $TZ
      # ë³´ì•ˆ ê¸°ë³¸ ì„¤ì •
      MM_SERVICESETTINGS_SITEURL: https://$domain
      MM_SERVICESETTINGS_LISTENADDRESS: ":80"
      MM_SERVICESETTINGS_CONNECTIONSECURITY: ""
      MM_SERVICESETTINGS_TLSCERTFILE: ""
      MM_SERVICESETTINGS_TLSKEYFILE: ""
      MM_SERVICESETTINGS_USELETSENCRYT: false
      MM_SERVICESETTINGS_FORWARD80TO443: false
      
      # ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²°
      MM_SQLSETTINGS_DRIVERNAME: postgres
      MM_SQLSETTINGS_DATASOURCE: postgres://mmuser:$default_pwd@postgres:5432/mattermost?sslmode=disable&connect_timeout=10
      
      # íŒŒì¼ ë° ê²€ìƒ‰ ì„¤ì •
      MM_BLEVESETTINGS_INDEXDIR: /mattermost/bleve-indexes
      MM_FILESETTINGS_MAXFILESIZE: 52428800  # 50MB
      
      # ë³´ì•ˆ ì„¤ì • - ì²« ì„¤ì¹˜ë¥¼ ìœ„í•´ ìˆ˜ì •
      MM_SERVICESETTINGS_ENABLEOPENSERVER: true  # ì²« ê´€ë¦¬ì ìƒì„±ì„ ìœ„í•´ true ìœ ì§€
      MM_SERVICESETTINGS_ENABLELOCALMODE: false
      MM_SERVICESETTINGS_ENABLEDEVELOPER: false
      MM_SERVICESETTINGS_ENABLETESTING: false
      MM_SERVICESETTINGS_ENABLESECURITYFIXALERT: true
      MM_SERVICESETTINGS_ENABLEINSECUREOUTGOINGCONNECTIONS: false
      MM_SERVICESETTINGS_ALLOWCORSFROM: ""
      MM_SERVICESETTINGS_CORSEXPOSEDHEADERS: ""
      MM_SERVICESETTINGS_CORSALLOWCREDENTIALS: false
      MM_SERVICESETTINGS_CORSDEBUG: false
      
      # ì´ë©”ì¼ ì„¤ì • (ë¹„í™œì„±í™”)
      MM_EMAILSETTINGS_SENDEMAILNOTIFICATIONS: false
      MM_EMAILSETTINGS_FEEDBACKEMAIL: ""
      MM_EMAILSETTINGS_REPLYTOADDRESS: ""
      
      # í”ŒëŸ¬ê·¸ì¸ ë³´ì•ˆ ì„¤ì •
      MM_PLUGINSETTINGS_ENABLE: true
      MM_PLUGINSETTINGS_ENABLEUPLOADS: false
      MM_PLUGINSETTINGS_AUTOMATICPREPACKAGEDPLUGINS: false
      MM_PLUGINSETTINGS_ENABLEHEALTHCHECK: true
      MM_PLUGINSETTINGS_PLUGINSTATES: '{"mattermost-ai":{"Enable":false},"com.mattermost.nps":{"Enable":false}}'
      
      # íŒ€ ë° ì‚¬ìš©ì ê´€ë¦¬ - ì²« ì„¤ì¹˜ë¥¼ ìœ„í•´ ìˆ˜ì •
      MM_TEAMSETTINGS_ENABLETEAMCREATION: true   # ì²« íŒ€ ìƒì„±ì„ ìœ„í•´ true
      MM_TEAMSETTINGS_ENABLEUSERCREATION: true   # ì²« ì‚¬ìš©ì ìƒì„±ì„ ìœ„í•´ true
      MM_TEAMSETTINGS_RESTRICTCREATIONTODOMAINS: ""
      MM_TEAMSETTINGS_RESTRICTDIRECTMESSAGE: "any"
      
      # ì„œë¹„ìŠ¤ ë³´ì•ˆ
      MM_SERVICESETTINGS_ENABLECOMMANDS: true
      MM_SERVICESETTINGS_ENABLEONLYAMININTEGRATIONS: false  # ì²« ì„¤ì •ì„ ìœ„í•´ false
      MM_SERVICESETTINGS_ENABLEPOSTUSERNAMEOVERRIDE: false
      MM_SERVICESETTINGS_ENABLEPOSTICONOVERRIDE: false
      MM_SERVICESETTINGS_ENABLECUSTOMEMOJI: true
      
      # ë¡œê·¸ ì„¤ì •
      MM_LOGSETTINGS_ENABLECONSOLE: true
      MM_LOGSETTINGS_CONSOLELEVEL: INFO  # ë””ë²„ê¹…ì„ ìœ„í•´ INFOë¡œ ë³€ê²½
      MM_LOGSETTINGS_ENABLEFILE: true
      MM_LOGSETTINGS_FILELEVEL: INFO
      
      # ë©”íŠ¸ë¦­ ë° ë¶„ì„ ë¹„í™œì„±í™” (í”„ë¼ì´ë²„ì‹œ)
      MM_METRICSSETTINGS_ENABLE: false
      MM_ANALYTICSETTINGS_MAXIMIZERUSERS: 1000
      
      # ë ˆì´íŠ¸ ë¦¬ë°‹ ì„¤ì • - ì´ˆê¸° ì„¤ì •ì„ ìœ„í•´ ì™„í™”
      MM_RATELIMITSETTINGS_ENABLE: true
      MM_RATELIMITSETTINGS_PERSEC: 30   # ì´ˆê¸° ì„¤ì •ì„ ìœ„í•´ ì¦ê°€
      MM_RATELIMITSETTINGS_MAXBURST: 300 # ì´ˆê¸° ì„¤ì •ì„ ìœ„í•´ ì¦ê°€
      
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:80/api/v4/system/ping"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 120s  # ì‹œì‘ ì‹œê°„ ì¦ê°€
    networks:
      - mattermost-internal

networks:
  mattermost-internal:
    driver: bridge
    internal: false

x-casaos:
  architectures:
    - amd64
    - arm64
  main: mattermost
  webui_port: 80
  author: CasaOS Team
  category: Chat
  description:
    en_us: Mattermost is an open-source, self-hostable online chat service with file sharing, search, and integrations. It is designed as an internal chat for organizations and companies, and is marketed as an open-source alternative to Slack and Microsoft Teams. This configuration prioritizes security with minimal plugin exposure and hardened settings.
    ko_kr: MattermostëŠ” íŒŒì¼ ê³µìœ , ê²€ìƒ‰ ë° í†µí•© ê¸°ëŠ¥ì„ ê°–ì¶˜ ì˜¤í”ˆ ì†ŒìŠ¤, ìì²´ í˜¸ìŠ¤íŒ… ê°€ëŠ¥í•œ ì˜¨ë¼ì¸ ì±„íŒ… ì„œë¹„ìŠ¤ì…ë‹ˆë‹¤. ì¡°ì§ê³¼ ê¸°ì—…ì„ ìœ„í•œ ë‚´ë¶€ ì±„íŒ…ìœ¼ë¡œ ì„¤ê³„ë˜ì—ˆìœ¼ë©° Slackê³¼ Microsoft Teamsì˜ ì˜¤í”ˆ ì†ŒìŠ¤ ëŒ€ì•ˆìœ¼ë¡œ ë§ˆì¼€íŒ…ë©ë‹ˆë‹¤. ì´ êµ¬ì„±ì€ ìµœì†Œí•œì˜ í”ŒëŸ¬ê·¸ì¸ ë…¸ì¶œê³¼ ê°•í™”ëœ ì„¤ì •ìœ¼ë¡œ ë³´ì•ˆì„ ìš°ì„ ì‹œí•©ë‹ˆë‹¤.
  developer: Mattermost, Inc.
  icon: https://cdn.jsdelivr.net/gh/Yundera/AppStore@main/Apps/Mattermost/icon.png
  screenshot_link:
    - https://cdn.jsdelivr.net/gh/Yundera/AppStore@main/Apps/Mattermost/screenshot-1.png
    - https://cdn.jsdelivr.net/gh/Yundera/AppStore@main/Apps/Mattermost/screenshot-2.png
    - https://cdn.jsdelivr.net/gh/Yundera/AppStore@main/Apps/Mattermost/screenshot-3.png
  tagline:
    en_us: Secure team communication platform with hardened configuration
    ko_kr: ê°•í™”ëœ êµ¬ì„±ì˜ ë³´ì•ˆ íŒ€ ì»¤ë®¤ë‹ˆì¼€ì´ì…˜ í”Œë«í¼
  thumbnail: https://cdn.jsdelivr.net/gh/Yundera/AppStore@main/Apps/Mattermost/thumbnail.png
  tips:
    before_install:
      en_us: |
        **ğŸ”’ Security-Hardened Mattermost Installation**

        **IMPORTANT: First Setup Steps**
        1. **Create admin account immediately** - Visit the web interface right after installation
        2. **Create your first team** - You'll be prompted during initial setup  
        3. **Secure the instance** - After setup, consider adjusting security settings

        **Security Features:**
        - Container runs with minimal privileges
        - Plugin uploads disabled by default
        - Rate limiting enabled (relaxed for initial setup)
        - Development/testing features disabled
        
        **Post-Installation Security (Recommended):**
        - Disable open server registration after first user
        - Review and enable only necessary plugins
        - Adjust rate limiting settings if needed
        - Set up proper backup procedures
        
        **Default Database:** PostgreSQL with secure password
        
        **Troubleshooting:**
        - If you see "List of admins is empty" errors, create an admin account through the web interface
        - Monitor logs in `/DATA/AppData/mattermost/logs/`
      ko_kr: |
        **ğŸ”’ ë³´ì•ˆ ê°•í™”ëœ Mattermost ì„¤ì¹˜**

        **ì¤‘ìš”: ì²« ì„¤ì • ë‹¨ê³„**
        1. **ì¦‰ì‹œ ê´€ë¦¬ì ê³„ì • ìƒì„±** - ì„¤ì¹˜ í›„ ì›¹ ì¸í„°í˜ì´ìŠ¤ ë°©ë¬¸
        2. **ì²« ë²ˆì§¸ íŒ€ ìƒì„±** - ì´ˆê¸° ì„¤ì • ì¤‘ ì•ˆë‚´ë¨
        3. **ì¸ìŠ¤í„´ìŠ¤ ë³´ì•ˆ** - ì„¤ì • í›„ ë³´ì•ˆ ì„¤ì • ì¡°ì • ê³ ë ¤

        **ë³´ì•ˆ ê¸°ëŠ¥:**
        - ìµœì†Œ ê¶Œí•œìœ¼ë¡œ ì»¨í…Œì´ë„ˆ ì‹¤í–‰
        - í”ŒëŸ¬ê·¸ì¸ ì—…ë¡œë“œ ê¸°ë³¸ ë¹„í™œì„±í™”
        - ë ˆì´íŠ¸ ë¦¬ë°‹ í™œì„±í™” (ì´ˆê¸° ì„¤ì •ìš©ìœ¼ë¡œ ì™„í™”)
        - ê°œë°œ/í…ŒìŠ¤íŠ¸ ê¸°ëŠ¥ ë¹„í™œì„±í™”
        
        **ì„¤ì¹˜ í›„ ë³´ì•ˆ (ê¶Œì¥):**
        - ì²« ì‚¬ìš©ì í›„ ê³µê°œ ì„œë²„ ë“±ë¡ ë¹„í™œì„±í™”
        - í•„ìš”í•œ í”ŒëŸ¬ê·¸ì¸ë§Œ ê²€í†  í›„ í™œì„±í™”
        - í•„ìš”ì‹œ ë ˆì´íŠ¸ ë¦¬ë°‹ ì„¤ì • ì¡°ì •
        - ì ì ˆí•œ ë°±ì—… ì ˆì°¨ ì„¤ì •
        
        **ê¸°ë³¸ ë°ì´í„°ë² ì´ìŠ¤:** ë³´ì•ˆ ë¹„ë°€ë²ˆí˜¸ê°€ ìˆëŠ” PostgreSQL
        
        **ë¬¸ì œ í•´ê²°:**
        - "ê´€ë¦¬ì ëª©ë¡ì´ ë¹„ì–´ìˆìŒ" ì˜¤ë¥˜ ì‹œ ì›¹ ì¸í„°í˜ì´ìŠ¤ì—ì„œ ê´€ë¦¬ì ê³„ì • ìƒì„±
        - `/DATA/AppData/mattermost/logs/`ì—ì„œ ë¡œê·¸ ëª¨ë‹ˆí„°ë§
  title:
    en_us: Mattermost (Security Hardened)
    ko_kr: Mattermost (ë³´ì•ˆ ê°•í™”)
  index: /
  port_map: "80"
  scheme: https
  store_app_id: mattermost
  pre_install_cmd: |
    rm -rf /DATA/AppData/$AppID/* &&
    mkdir -p /DATA/AppData/$AppID/{config,data,logs,plugins,client-plugins,bleve-indexes,postgres} &&
    chown -R 70:70 /DATA/AppData/$AppID/postgres &&
    chown -R $PUID:$PGID /DATA/AppData/$AppID/config /DATA/AppData/$AppID/data /DATA/AppData/$AppID/logs /DATA/AppData/$AppID/plugins /DATA/AppData/$AppID/client-plugins /DATA/AppData/$AppID/bleve-indexes &&
    chmod -R 755 /DATA/AppData/$AppID/config /DATA/AppData/$AppID/data /DATA/AppData/$AppID/logs /DATA/AppData/$AppID/plugins /DATA/AppData/$AppID/client-plugins /DATA/AppData/$AppID/bleve-indexes &&
    echo "Secure Mattermost installation setup completed"