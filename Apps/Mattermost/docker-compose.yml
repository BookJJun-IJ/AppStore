name: mattermost

services:
  postgres:
    image: postgres:13-alpine
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
    volumes:
      - /DATA/AppData/$AppID/postgres:/var/lib/postgresql/data
    environment:
      POSTGRES_USER: mmuser
      POSTGRES_PASSWORD: $default_pwd
      POSTGRES_DB: mattermost
      POSTGRES_INITDB_ARGS: "--encoding=UTF-8"
      PGDATA: /var/lib/postgresql/data/pgdata
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U mmuser -d mattermost"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 120s

  nextcloud:
    image: nextcloud:28-apache
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
    expose:
      - 80
    volumes:
      - /DATA/AppData/$AppID/nextcloud/html:/var/www/html
      - /DATA/AppData/$AppID/nextcloud/data:/var/www/html/data
      - /DATA/Media:/var/www/html/data/shared_media
      - /DATA/Documents:/var/www/html/data/shared_docs
    environment:
      NEXTCLOUD_ADMIN_USER: admin
      NEXTCLOUD_ADMIN_PASSWORD: $default_pwd
      NEXTCLOUD_TRUSTED_DOMAINS: "4000-$domain"
      MYSQL_HOST: db
      MYSQL_DATABASE: nextcloud
      MYSQL_USER: nextcloud
      MYSQL_PASSWORD: $default_pwd
    depends_on:
      - db

  db:
    image: mariadb:10.11
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: '0.3'
    volumes:
      - /DATA/AppData/$AppID/mariadb:/var/lib/mysql
    environment:
      MYSQL_ROOT_PASSWORD: $default_pwd
      MYSQL_DATABASE: nextcloud
      MYSQL_USER: nextcloud
      MYSQL_PASSWORD: $default_pwd
    restart: unless-stopped
    depends_on:
      - postgres
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: '1.0'
    expose:
      - 3000
    volumes:
      - /DATA/AppData/$AppID/config:/mattermost/config
      - /DATA/AppData/$AppID/data:/mattermost/data
      - /DATA/AppData/$AppID/logs:/mattermost/logs
      - /DATA/AppData/$AppID/plugins:/mattermost/plugins
    environment:
      PUID: $PUID
      PGID: $PGID
      TZ: $TZ
      
      # Core Database Settings
      MM_SQLSETTINGS_DRIVERNAME: postgres
      MM_SQLSETTINGS_DATASOURCE: postgres://mmuser:$default_pwd@postgres:5432/mattermost?sslmode=disable&connect_timeout=10
      
      # Server Settings for Teams Alternative
      MM_SERVICESETTINGS_SITEURL: "https://3000-$domain"
      MM_SERVICESETTINGS_LISTENADDRESS: ":3000"
      MM_SERVICESETTINGS_ENABLELOCALMODE: true
      MM_SERVICESETTINGS_ALLOWUNTRUSTEDINTERNALCONNECTIONS: true
      MM_SERVICESETTINGS_ENABLEINSECUREOUTGOINGCONNECTIONS: true
      MM_SERVICESETTINGS_ALLOWCORSFROM: "*"
      MM_SERVICESETTINGS_WEBSOCKETURL: ""
      MM_SERVICESETTINGS_ENABLEFILEATTACHMENTS: true
      
      # Teams Alternative with Plugin Marketplace
      MM_PLUGINSETTINGS_ENABLE: true
      MM_PLUGINSETTINGS_ENABLEUPLOADS: true
      MM_PLUGINSETTINGS_AUTOMATICPREPACKAGEDPLUGINS: true
      MM_PLUGINSETTINGS_ENABLEREMOTEMARKETPLACE: true
      MM_PLUGINSETTINGS_MARKETPLACEURL: "https://api.integrations.mattermost.com"
      
      # Video Conferencing (Teams calls replacement)
      MM_PLUGINSETTINGS_ENABLEJITSI: true
      MM_PLUGINSETTINGS_ENABLEZOOM: true
      
      # File and Media Settings (Teams file sharing)
      MM_FILESETTINGS_MAXFILESIZE: 104857600
      MM_FILESETTINGS_ENABLEFILEATTACHMENTS: true
      MM_FILESETTINGS_ENABLEPUBLICLINK: true
      MM_FILESETTINGS_ENABLEMOBILEUPLOAD: true
      MM_FILESETTINGS_ENABLEMOBILEDOWNLOAD: true
      
      # Team and User Management
      MM_TEAMSETTINGS_ENABLETEAMCREATION: true
      MM_TEAMSETTINGS_ENABLEUSERCREATION: true
      MM_TEAMSETTINGS_ENABLEOPENSERVER: false
      MM_TEAMSETTINGS_RESTRICTCREATIONTDOMAINS: ""
      
      # Notification Settings (Teams alerts replacement)
      MM_NOTIFICATIONSETTINGS_DEFAULTSERVERPUSHENABLED: true
      MM_NOTIFICATIONSETTINGS_DEFAULTCHANNELPUSHENABLED: true
      MM_NOTIFICATIONSETTINGS_DEFAULTDESKTOPNOTIFICATIONSENABLED: true
      MM_NOTIFICATIONSETTINGS_DEFAULTPUSHSTATUS: "mention"
      
      # Email Integration (Teams notifications)
      MM_EMAILSETTINGS_SENDEMAILNOTIFICATIONS: true
      MM_EMAILSETTINGS_ENABLEEMAILBATCHING: true
      MM_EMAILSETTINGS_EMAILBATCHINGBUFFERSIZE: 256
      MM_EMAILSETTINGS_EMAILBATCHINGINTERVAL: 30
      
      # Security and Privacy
      MM_PRIVACYSETTINGS_SHOWEMAILADDRESS: true
      MM_PRIVACYSETTINGS_SHOWFULLNAME: true
      
      # Logging for Teams Migration
      MM_LOGSETTINGS_CONSOLELEVEL: "INFO"
      MM_LOGSETTINGS_FILELEVEL: "INFO"

x-casaos:
  architectures: [amd64, arm64]
  main: mattermost
  webui_port: 3000
  author: Yundera Team
  category: Communication
  description:
    en_us: Complete Microsoft Teams alternative with video calls, file sharing, team collaboration, and enterprise features
    ko_kr: 화상 통화, 파일 공유, 팀 협업 및 엔터프라이즈 기능을 갖춘 완전한 Microsoft Teams 대체 솔루션
    fr_fr: Alternative complète à Microsoft Teams avec appels vidéo, partage de fichiers, collaboration d'équipe et fonctionnalités d'entreprise
    es_es: Alternativa completa a Microsoft Teams con videollamadas, intercambio de archivos, colaboración en equipo y funciones empresariales
    zh_cn: 具有视频通话、文件共享、团队协作和企业功能的完整Microsoft Teams替代方案
  developer: Mattermost, Inc.
  icon: https://cdn.jsdelivr.net/gh/Yundera/AppStore@main/Apps/Mattermost/icon.png
  tagline:
    en_us: Enterprise Teams alternative - self-hosted
    ko_kr: 엔터프라이즈 Teams 대체 - 자체 호스팅
    fr_fr: Alternative Teams d'entreprise - auto-hébergée
    es_es: Alternativa Teams empresarial - auto-alojada
    zh_cn: 企业Teams替代方案 - 自托管
  title:
    en_us: Mattermost
    ko_kr: Mattermost
  pre-install-cmd: mkdir -p /DATA/AppData/$AppID/config /DATA/AppData/$AppID/data /DATA/AppData/$AppID/logs /DATA/AppData/$AppID/plugins /DATA/AppData/$AppID/postgres && chown -R $PUID:$PGID /DATA/AppData/$AppID
  index: /
  port_map: "3000"
  store_app_id: mattermost