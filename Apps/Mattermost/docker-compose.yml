name: mattermost

services:
  postgres:
    image: postgres:13-alpine
    user: $PUID:$PGID
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
    volumes:
      - /DATA/AppData/$AppID/postgres:/var/lib/postgresql/data
    environment:
      POSTGRES_USER: mmuser
      POSTGRES_PASSWORD: $default_pwd
      POSTGRES_DB: mattermost
      POSTGRES_INITDB_ARGS: "--encoding=UTF-8"
      PGDATA: /var/lib/postgresql/data/pgdata
      PUID: $PUID
      PGID: $PGID
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U mmuser -d mattermost"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 120s

  mattermost:
    image: mattermost/mattermost-team-edition:10.9.1
    user: $PUID:$PGID
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: '1.0'
    expose:
      - 3000
    volumes:
      - /DATA/AppData/$AppID/config:/mattermost/config
      - /DATA/AppData/$AppID/data:/mattermost/data
      - /DATA/AppData/$AppID/logs:/mattermost/logs
      - /DATA/AppData/$AppID/plugins:/mattermost/plugins
      - /DATA/AppData/$AppID/client-plugins:/mattermost/client/plugins
    environment:
      PUID: $PUID
      PGID: $PGID
      TZ: $TZ
      MM_SQLSETTINGS_DRIVERNAME: postgres
      MM_SQLSETTINGS_DATASOURCE: postgres://mmuser:$default_pwd@postgres:5432/mattermost?sslmode=disable&connect_timeout=10
      MM_SERVICESETTINGS_SITEURL: "https://3000-$domain"
      MM_SERVICESETTINGS_LISTENADDRESS: ":3000"
      MM_SERVICESETTINGS_ENABLELOCALMODE: true
      MM_SERVICESETTINGS_ALLOWUNTRUSTEDINTERNALCONNECTIONS: true
      MM_SERVICESETTINGS_ENABLEINSECUREOUTGOINGCONNECTIONS: true
      MM_SERVICESETTINGS_ALLOWCORSFROM: "*"
      MM_SERVICESETTINGS_WEBSOCKETURL: ""
      MM_SERVICESETTINGS_ENABLEFILEATTACHMENTS: true
      MM_PLUGINSETTINGS_ENABLE: true
      MM_PLUGINSETTINGS_ENABLEUPLOADS: true
      MM_PLUGINSETTINGS_AUTOMATICPREPACKAGEDPLUGINS: true
      MM_PLUGINSETTINGS_ENABLEREMOTEMARKETPLACE: true
      MM_FILESETTINGS_MAXFILESIZE: 104857600
      MM_FILESETTINGS_ENABLEFILEATTACHMENTS: true
      MM_FILESETTINGS_ENABLEPUBLICLINK: true
      MM_TEAMSETTINGS_ENABLETEAMCREATION: true
      MM_TEAMSETTINGS_ENABLEUSERCREATION: true
      MM_EMAILSETTINGS_SENDEMAILNOTIFICATIONS: false
      MM_LOGSETTINGS_CONSOLELEVEL: "INFO"
      MM_LOGSETTINGS_FILELEVEL: "INFO"
      # Calls 플러그인 설정 - 테스트 모드 비활성화
      MM_PLUGINSETTINGS_PLUGINS_COM_MATTERMOST_CALLS_ENABLEPLUGIN: true
      MM_PLUGINSETTINGS_PLUGINS_COM_MATTERMOST_CALLS_ALLOWUSERSTOSTARTCALLS: true
      MM_PLUGINSETTINGS_PLUGINS_COM_MATTERMOST_CALLS_TESTMODE: false
      MM_PLUGINSETTINGS_PLUGINS_COM_MATTERMOST_CALLS_DEFAULTENABLED: true
      MM_PLUGINSETTINGS_PLUGINS_COM_MATTERMOST_CALLS_ALLOWSCREENSHARING: true
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/api/v4/system/ping"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 90s

x-casaos:
  architectures: [amd64, arm64]
  main: mattermost
  webui_port: 3000
  author: Yundera Team
  category: Communication
  pre-install-cmd: |
    mkdir -p /DATA/AppData/$AppID/client-plugins &&
    mkdir -p /DATA/AppData/$AppID/config &&
    mkdir -p /DATA/AppData/$AppID/data &&
    mkdir -p /DATA/AppData/$AppID/logs &&
    mkdir -p /DATA/AppData/$AppID/plugins &&
    mkdir -p /DATA/AppData/$AppID/postgres &&
    chown -R $PUID:$PGID /DATA/AppData/$AppID/ &&
    echo "Downloading Jitsi Plugin..." &&
    curl -L -o /DATA/AppData/$AppID/jitsi-plugin.tar.gz "https://github.com/mattermost-community/mattermost-plugin-jitsi/releases/latest/download/com.mattermost.plugin-jitsi.tar.gz" &&
    echo "Jitsi Plugin downloaded to /DATA/AppData/$AppID/jitsi-plugin.tar.gz" &&
    echo "Install it via System Console > Plugins > Plugin Management after first login"
  description:
    en_us: Self-hosted Microsoft Teams alternative with voice calls, video calls, screen sharing and team collaboration powered by Jitsi
    ko_kr: Jitsi 기반 음성 통화, 화상 통화, 화면 공유 및 팀 협업 기능을 갖춘 자체 호스팅 Microsoft Teams 대체 솔루션
    fr_fr: Alternative auto-hébergée à Microsoft Teams avec appels vocaux, appels vidéo, partage d'écran et collaboration d'équipe alimentés par Jitsi
    es_es: Alternativa auto-alojada a Microsoft Teams con llamadas de voz, videollamadas, intercambio de pantalla y colaboración en equipo con Jitsi
    zh_cn: 基于Jitsi的自托管Microsoft Teams替代方案，具有语音通话、视频通话、屏幕共享和团队协作功能
  developer: Mattermost, Inc.
  icon: https://cdn.jsdelivr.net/gh/Yundera/AppStore@main/Apps/Mattermost/icon.png
  tagline:
    en_us: Microsoft Teams alternative with voice, video calls, and screen sharing via Jitsi
    ko_kr: Jitsi 기반 음성, 화상 통화 및 화면 공유 기능을 갖춘 Microsoft Teams 대체 솔루션
    fr_fr: Alternative à Microsoft Teams avec appels vocaux, vidéo et partage d'écran via Jitsi
    es_es: Alternativa a Microsoft Teams con llamadas de voz, video y pantalla compartida via Jitsi
    zh_cn: 通过Jitsi实现语音、视频通话和屏幕共享的Microsoft Teams替代方案
  title:
    en_us: Mattermost
    ko_kr: Mattermost
  index: /
  port_map: "3000"
  store_app_id: mattermost